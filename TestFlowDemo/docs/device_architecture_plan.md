# æ±½è½¦ç”µæ£€è®¾å¤‡ç®¡ç†ä¸æµ‹è¯•æµç¨‹æ¶æ„æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“Œ ç”¨æˆ·è¯‰æ±‚

1. **è®¾å¤‡å¤šæ ·æ€§**

   - å½“å‰ç³»ç»Ÿæ¶‰åŠå¤šç§è®¾å¤‡ä¸æ¥å£ï¼šCOM ä¸²å£ã€CANã€Modbusã€TCPã€UDP ç­‰ã€‚
   - éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡å±‚ï¼Œå‡å°‘å†—ä½™ä»£ç ã€‚

2. **é…ç½®é©±åŠ¨**

   - è®¾å¤‡ä¸æœåŠ¡çš„æ¸…å•é€šè¿‡ JSON æ–‡ä»¶ç»´æŠ¤ã€‚
   - å¸Œæœ›é€šè¿‡é…ç½®æ–‡ä»¶å³å¯æ–°å¢/ä¿®æ”¹è®¾å¤‡ï¼Œè€Œæ— éœ€æ”¹åŠ¨ä¸»ç¨‹åºã€‚

3. **æµç¨‹é©±åŠ¨**

   - æµ‹è¯•æµç¨‹éœ€è¦é€šè¿‡ JSON å®šä¹‰ï¼ŒåŠ¨æ€æ˜ å°„åˆ°è®¾å¤‡ï¼Œå‘é€å‘½ä»¤å¹¶éªŒè¯å“åº”ã€‚
   - è¦æ±‚æ”¯æŒä¾èµ–å…³ç³»ã€å­æµç¨‹ã€æˆåŠŸ/å¤±è´¥åˆ†æ”¯ã€‚

4. **é•¿æœŸæ¼”è¿›**

   - ç³»ç»Ÿéœ€å…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§ï¼šæœªæ¥å¯èƒ½æ–°å¢ 10+ è®¾å¤‡ç±»å‹å’Œåè®®ã€‚
   - æ’ä»¶åŒ–ï¼ˆDLL åŠ¨æ€åŠ è½½ï¼‰ï¼Œé¿å…ä¿®æ”¹ä¸»ç¨‹åºã€‚

5. **é¡¹ç›®éœ€è¦æ¶æ„éœ€è¦é‡æ–°è§„åˆ’**

   - ç³»ç»Ÿéœ€å…·å¤‡è‰¯å¥½çš„åˆ†å±‚æˆ–åˆ†é¡¹ç›®ï¼ˆä½œä¸ºå•ç‹¬çš„ Libaryï¼Œä¾›ä½¿ç”¨æ–¹ä½¿ç”¨ï¼‰ã€‚
   - å·¥ä½œæµä¸€ä¸ª Libary
   - è®¾å¤‡å±‚ä¸€ä¸ª Libary

6. **æŠ€æœ¯é€‰å‹**
   - ä¿ç•™ç°åœ¨å·²æœ‰çš„ WorkflowCore 3.15 ç‰ˆæœ¬ä½œä¸ºå·¥ä½œæµçš„å†…æ ¸ï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šæ‰©å±•åº”ç”¨çš„å®—æ—¨ã€‚
   - å•ç‹¬çš„ Libaryï¼Œè¯·å…¼å®¹ .net framework å’Œ .net core ç‰ˆæœ¬ï¼›LangVersion ä½¿ç”¨ 7.0 å…¼å®¹çš„è¯­æ³•ï¼›
   - æµ‹è¯•éƒ¨åˆ†ä¿ç•™ç°æœ‰ winform + sqlite æ•°æ®åº“è¿›è¡Œæµ‹è¯•ï¼›

---

## âš ï¸ ç›®å‰å­˜åœ¨çš„é—®é¢˜

1. **Devices.json è¯­ä¹‰ä¸æ¸…æ™°**

   - æ··åˆäº†ã€Œç‰©ç†è®¾å¤‡ã€å’Œã€Œç¯å¢ƒæœåŠ¡ã€ï¼ˆdatabaseã€report_generatorã€systemï¼‰ã€‚
   - ä¸åˆ©äºåŒºåˆ†èŒè´£ã€‚

2. **å·¥å‚ç±» CreateInternal è¿‡åº¦ç¡¬ç¼–ç **

   - ä½¿ç”¨å¤§é‡ `if/else` æ¥åŒºåˆ†è®¾å¤‡ç±»å‹ã€‚
   - éšç€è®¾å¤‡å¢å¤šï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œæ‰©å±•æ€§å·®ã€‚

3. **è®¾å¤‡ä¸åè®®è€¦åˆ**

   - ä¸åŒåè®®çš„é€šè®¯é€»è¾‘ï¼ˆCOM/CAN/TCP/UDPï¼‰ç›´æ¥å†™åœ¨è®¾å¤‡ç±»é‡Œã€‚
   - è®¾å¤‡æ— æ³•å¤ç”¨åˆ°ä¸åŒçš„é€šè®¯æ–¹å¼ã€‚

4. **æµç¨‹ä¸è®¾å¤‡ç»‘å®šç´§å¯†**
   - æµ‹è¯•æ­¥éª¤ä¸­çš„ `Device` ç¡¬ç¼–ç ä¸ºå…·ä½“å®ä¾‹åã€‚
   - ç¼ºå°‘æ›´çµæ´»çš„æ˜ å°„æœºåˆ¶ã€‚

---

## âœ… æ”¹è¿›æ–¹æ¡ˆ

> èŒƒå›´æ”¶æ•›ï¼ˆå°è€Œç¾ï¼‰ï¼šçŸ­æœŸä¸å¼•å…¥ DLL æ‰«æä¸è·¨è¿›ç¨‹æœåŠ¡ï¼›ä¼˜å…ˆç”¨â€œæ³¨å†Œè¡¨ + å•ä½“å¯æ‰§è¡Œâ€çš„æ–¹å¼è¾¾æˆè§£è€¦ä¸å¯æ‰©å±•ï¼Œå¾…è®¾å¤‡ç±»å‹æ˜¾è‘—å¢é•¿åå†è¯„ä¼°æ’ä»¶åŒ–ã€‚

### 1. æ–‡ä»¶ç»„ç»‡ä¼˜åŒ–

æ‹†åˆ†é…ç½®æ–‡ä»¶ï¼š

- **infrastructure.json**  
  å­˜æ”¾æ•°æ®åº“ã€æŠ¥å‘Šç”Ÿæˆå™¨ã€ç³»ç»ŸæœåŠ¡ç­‰éç‰©ç†è®¾å¤‡ã€‚
- **devices.json**  
  å­˜æ”¾å®é™…çš„ç¡¬ä»¶/è™šæ‹Ÿè®¾å¤‡åŠå…¶åè®®é…ç½®ã€‚
- **flows.jsonï¼ˆä¸€ç§å‹å·ä¸€ä¸ª json æ–‡ä»¶ï¼‰**  
  å­˜æ”¾æµ‹è¯•æµç¨‹å®šä¹‰ã€‚

### 2. ä¼ è¾“å±‚æŠ½è±¡ ITransport

å®šä¹‰ç»Ÿä¸€çš„é€šè®¯æ¥å£ï¼š

```csharp
public interface ITransport : IDisposable
{
    void Connect();
    void Disconnect();
    void Send(string message);
    string Receive(Func<string, bool> predicate, int timeout, CancellationToken token);
    bool IsConnected { get; }
}
```

- æ¯ç§åè®®ï¼ˆCOMã€TCPã€UDPã€CANã€Modbusï¼‰å®ç°ä¸€ä¸ª `ITransport` å­ç±»ã€‚
- è®¾å¤‡ç±»ä¸å…³å¿ƒåº•å±‚é€šè®¯æ–¹å¼ï¼Œåªè´Ÿè´£ä¸šåŠ¡å‘½ä»¤ã€‚

### 3. è®¾å¤‡æŠ½è±¡ DeviceBase

```csharp
public abstract class DeviceBase : IDevice
{
    protected readonly ITransport _transport;

    protected DeviceBase(ITransport transport) => _transport = transport;

    public DeviceExecResult Execute(StepConfig step, StepContext ctx)
    {
        var outputs = new Dictionary<string, object>();
        try { return HandleCommand(step, ctx, outputs, ctx.Cancellation); }
        catch (Exception ex) { return new DeviceExecResult { Success = false, Message = ex.Message, Outputs = outputs }; }
    }

    protected abstract DeviceExecResult HandleCommand(StepConfig step, StepContext ctx, Dictionary<string, object> outputs, CancellationToken token);
}
```

å­ç±»åªéœ€è¦å®ç°å…·ä½“å‘½ä»¤é€»è¾‘ã€‚

### 4. å·¥å‚æ¨¡å¼æ”¹é€ ï¼ˆæ³¨å†Œè¡¨ + æ’ä»¶åŒ–ï¼‰

ä½¿ç”¨æ³¨å†Œè¡¨æˆ–åå°„æ›¿ä»£ if/elseï¼š

```csharp
registry.Register("resistor_box", cfg => new ResistorBoxDevice(cfg));
registry.Register("voltmeter", cfg => new VoltmeterDevice(cfg));
```

- æœªæ¥æ–°å¢è®¾å¤‡åªéœ€å†™ç±» + æ³¨å†Œï¼Œä¸éœ€ä¿®æ”¹ä¸»ç¨‹åºã€‚
- å·²å®ç°æ’ä»¶åŒ–ï¼š`Plugins/*.dll` è‡ªåŠ¨æ‰«æï¼Œæ”¯æŒ `IDeviceRegistrar` ä¸ `[DeviceType]` ä¸¤ç§æ³¨å†Œæ–¹å¼ï¼›å¯åœ¨ä¸æ”¹ä¸»ç¨‹åºçš„æƒ…å†µä¸‹æ–°å¢/å‡çº§é©±åŠ¨ã€‚

### 5. æµç¨‹å¼•æ“è®¾è®¡

- æ”¯æŒ **å­æµç¨‹ (SubFlow)**ã€**æ¡ä»¶åˆ†æ”¯ (OnSuccess/OnFailure)**ã€**å¹¶è¡Œ/å¾ªç¯**ã€‚
- æ‰§è¡Œæ—¶ç”± `FlowEngine` è°ƒåº¦ï¼Œè®¾å¤‡ç”± `DeviceManager` æä¾›ã€‚

### 6. å‘½åä¼˜åŒ–

- `Devices.json` â†’ **devices.json**
- `infrastructure.json` â†’ ç¯å¢ƒæœåŠ¡é…ç½®
- `flows.json` â†’ æµ‹è¯•æµç¨‹å®šä¹‰
- `DeviceFactoryRegistry` â†’ æ’ä»¶åŒ–å·¥å‚æ³¨å†Œè¡¨

---

## ğŸ¯ æœ€ç»ˆç›®æ ‡

1. **é…ç½®é©±åŠ¨**

   - æ–°å¢è®¾å¤‡/åè®®åªéœ€ä¿®æ”¹ JSON å’Œå¢åŠ å¯¹åº”å®ç°ç±»ã€‚

2. **è§£è€¦è®¾è®¡**

   - åè®®ï¼ˆTransportï¼‰ä¸è®¾å¤‡ï¼ˆDeviceï¼‰å®Œå…¨åˆ†ç¦»ã€‚

3. **æ’ä»¶åŒ–æ‰©å±•**

   - æ–°è®¾å¤‡ DLL å¯ç›´æ¥åŠ è½½ï¼Œæ— éœ€æ”¹åŠ¨ä¸»ç¨‹åºã€‚

4. **æµç¨‹çµæ´»æ€§**

   - JSON å®šä¹‰æµ‹è¯•æµç¨‹ï¼Œæ”¯æŒä¾èµ–ã€åˆ†æ”¯ã€å­æµç¨‹ã€‚

5. **ç»Ÿä¸€ç®¡ç†**
   - `DeviceManager`ï¼šè´Ÿè´£è®¾å¤‡ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
   - `FlowEngine`ï¼šè´Ÿè´£æµ‹è¯•æµç¨‹æ‰§è¡Œã€‚
   - æ¸…æ™°åˆ†å±‚ï¼ŒèŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

---

## ğŸ“Š æ¶æ„å›¾

```
+--------------------------------------------------+
|                  FlowEngine                      |
|             (æµç¨‹é©±åŠ¨æ‰§è¡Œå¼•æ“)                    |
+--------------------------------------------------+
                     |
                     v
+--------------------------------------------------+
|                  DeviceManager                   |
|        (è®¾å¤‡/æœåŠ¡åŠ è½½ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†)              |
+--------------------------------------------------+
     |                        |
     v                        v
+------------+         +---------------+
|  IDevice   |         | Infrastructure|
| (ç‰©ç†è®¾å¤‡) |         | (DB/Report..) |
+------------+         +---------------+
     |
     v
+-------------------+
|   ITransport      |
| (åè®®: COM/TCP..) |
+-------------------+
```

---

## ğŸš€ æ€»ç»“

- **çŸ­æœŸæ”¹è¿›**ï¼šæ‹†åˆ†é…ç½®æ–‡ä»¶ã€å¼•å…¥ ITransportã€é‡æ„å·¥å‚ä¸ºæ³¨å†Œè¡¨ã€‚
- **ä¸­æœŸæ”¹è¿›**ï¼šå¼•å…¥ FlowEngineï¼Œæ”¯æŒå­æµç¨‹ã€æ¡ä»¶åˆ†æ”¯ã€‚
- **é•¿æœŸç›®æ ‡**ï¼šæ’ä»¶åŒ–ã€é…ç½®é©±åŠ¨ï¼Œæ„å»ºå¯æ‰©å±•çš„æµ‹è¯•æ‰§è¡Œå¹³å°ã€‚
