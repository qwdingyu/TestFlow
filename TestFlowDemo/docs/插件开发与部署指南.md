# 插件驱动开发与部署指南（独立 DLL 自动加载）

本文介绍如何以“独立库 DLL”的方式交付设备驱动，并在程序启动时自动反射加载，无需改动或重新分发主程序。

## 1. 方案概览
- 插件位置：程序运行目录的 `Plugins/` 文件夹（WinForms 与 CLI 均相同）。
- 注册方式（二选一）：
  - 在设备类上标注 `[DeviceType("YourType")]`；或
  - 在插件内实现 `IDeviceRegistrar` 并在 `Register` 中调用 `factory.Register("YourType", ...)`。
- 运行时加载：主程序与 CLI 在启动时自动扫描 `Plugins/*.dll` 并注册设备类型。

## 2. 新建插件工程
- 目录：仓库根下 `PluginsSrc/<PluginName>/`（可由 CLI 脚手架生成）。
- csproj 建议：
  - `<TargetFrameworks>net48;net7.0</TargetFrameworks>`（兼容 WinForms 与 CLI）
  - `<LangVersion>7.0</LangVersion>`、`<Nullable>disable</Nullable>`、`<ImplicitUsings>disable</ImplicitUsings>`
  - 引用：`Libraries/DeviceLib/DeviceLib.csproj`

## 3. 设备代码示例
```csharp
using System;
using System.Collections.Generic;
using Plugin;
using TestFlowDemo.Devices;  // IDevice, DeviceExecResult
using TestFlowDemo.Models;   // DeviceConfig
using TestFlowDemo.Engine;   // StepContext

[DeviceType("MyDriver")] // 或在 Registrar 中集中注册
public class MyDriverDevice : IDevice
{
    public MyDriverDevice(DeviceConfig cfg) { /* 读取 cfg.ConnectionString/cfg.Settings */ }

    public DeviceExecResult Execute(StepConfig step, StepContext ctx)
    {
        var outputs = new Dictionary<string, object>();
        try { outputs["status"] = "ok"; return new DeviceExecResult{ Success = true, Message = "MyDriver ok", Outputs = outputs }; }
        catch (OperationCanceledException) { return new DeviceExecResult{ Success=false, Message="cancelled", Outputs=outputs}; }
        catch (Exception ex) { return new DeviceExecResult{ Success=false, Message = ex.Message, Outputs = outputs}; }
    }
}
```

可选 Registrar（集中注册）：
```csharp
using TestFlowDemo.Devices;
using Plugin;

public class MyDriverRegistrar : IDeviceRegistrar
{
    public void Register(DeviceFactory factory)
    {
        factory.Register("MyDriver", (_, cfg) => new MyDriverDevice(cfg));
    }
}
```

## 4. 部署与验证
- 编译插件工程，得到 `MyDriver.dll`。
- 拷贝到：
  - CLI：`Tools/FlowCli/bin/<配置>/net7.0/Plugins/MyDriver.dll`
  - WinForms：`TestFlowDemo/bin/<配置>/<TFM>/Plugins/MyDriver.dll`
- 在 `devices.json` 中新增设备条目：
```json
{
  "Devices": {
    "my_driver_1": { "Type": "MyDriver", "ConnectionString": "SIM:", "Settings": {} }
  }
}
```
- 在某个流程步骤引用 `my_driver_1`，或使用内置的示例步骤 `mydriver_demo`（E311 已集成）。
- 验证（CLI）：`dotnet run --project Tools/FlowCli -- run E311-TESTSN001 --timeout 120`

## 5. 注意事项
- 框架匹配：CLI 运行 net7.0 时优先使用插件的 net7.0 目标；WinForms 使用 net48。
- 串口仿真：`ConnectionString` 以 `SIM:` 开头或非 Windows 平台将自动仿真，便于本地/CI 验证。
- 设备类型字符串（如 `MyDriver`）需与 `devices.json` 的 `Type` 完全一致（区分大小写）。

